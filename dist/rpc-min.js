var channelCounter=0,RPC=function(e){function f(e){var r={success:function(n){e.id&&t.send({id:e.id,result:n});return},error:function(n,r,i){if(e.id){var s={id:e.id,error:{code:i||-32099,message:n}};r&&(s.data=r),t.send(s)}return}},i=s[e.method];if(!n.lang.isFunction(i))return r.error("Procedure not found.",null,-32601);var o;try{n.lang.isArray(e.params)||(e.params=[e.params]),o=i.apply({},e.params)}catch(u){r.error(u.message,u.data)}o&&r.success(o)}var t=this,n=RPC._util,r=function(){};e=e||{},e.isHost=e.remote?!0:!1,e.channel="RPC_CHANNEL_"+channelCounter++;var i={},s=e.method=e.method||{},o=1,u=new RPC.Transport(e);u.on("ready",function(){n.lang.isFunction(e.onReady)&&e.onReady.call(t)}),u.on("message",function(e,r){try{r=n.JSON.parse(r)}catch(s){t.send({jsonrpc:"2.0",error:{code:-32700,message:"Parse error."},id:null});return}if(r.method)f(r);else if(r.id){var o=i[r.id];o&&(r.result?o.success(r.result):o.error(r.error))}}),this.send=function(e){u.send(n.JSON.stringify(e))};var a=function(e,r,s,u){var a={jsonrpc:"2.0",method:e,params:r};n.lang.isFunction(r)&&(u=s,s=r);if(n.lang.isFunction(s)||n.lang.isFunction(u))a.id=o,i[o]={success:s||function(){},error:u||function(){}};o++,setTimeout(function(){t.send(a)},0)};return a.set=function(e,t){s[e]=t},a.destroy=function(){o=0,s={},i={},u.destroy()},u.init(),a.iframe=e.iframe,a};RPC._util={},RPC.behavior={},function(){var e={};if(window.RPC_Fn)return;window.RPC_Fn={set:function(t,n){e[t]=n},get:function(t){return e[t]},remove:function(t){delete e[t]}}}(),typeof module!="undefined"&&(module.exports=RPC),function(e){var t=Array.prototype,n=Object.prototype,r=Function.prototype,i=t.slice,s=t.forEach,o=function(e,t,n){if(!e)return;if(s&&e.forEach===s)e.forEach(t,n);else if(e.length===+e.length)for(var r=0,i=e.length;r<i;r++)r in e&&t.call(n,e[r],r,e);else for(var o in e)e.hasOwnProperty(o)&&t.call(n,e[o],o,e)};e.lang={isUndefined:function(e){return e===void 0},isArray:function(e){return e?Object.prototype.toString.call(e)==="[object Array]":!1},isFunction:function(e){return typeof e=="function"},extend:function(t,n,r){for(var i in n)if(i in t){var s=n[i];typeof s=="object"?e.lang.extend(t[i],s,r):r&&(t[i]=n[i])}else t[i]=n[i];return t},has:function(e,t){var n=typeof e[t];return n=="function"||n=="object"&&!!e[t]||n=="unknown"},each:o,forEach:o}}(RPC._util),function(e){var t=/^((https?:)\/\/([^:\/\s]+)(:\d+)*)/;e.url={getPort:function(e){},getMainDomain:function(t){var n=e.url.getDomain(t),r=/([^:\/\s\.]+)\.([^:\/\s\.]+)$/;if(n&&r.test(n))return n.match(r)[0]},getDomain:function(e){var n=e.toLowerCase().match(t);if(n)return n[3]},resolve:function(e){},getOrigin:function(e){var n=e.toLowerCase().match(t);if(n)return n[1]},removeHash:function(e){var t=e.indexOf("#");return e.substr(0,t)}}}(RPC._util),function(e){e.eventEmiter=function(e){var t={};e.on=function(e,n,r){t[e]=t[e]||[],t[e].push({fn:n,scope:r})},e.once=function(e,n,r){t[e]=t[e]||[],t[e].push({fn:n,scope:r,type:1})},e.off=function(e,n){t||(t[e]=[]);var r=t[e]=t[e]||[],i,s=[];while(r.length)i=r.shift(),i.fn!==n&&s.push(i);t[e]=s},e.emit=function(e){var n=t[e]=t[e]||[],r,i=[],s=Array.prototype.slice.call(arguments,1);while(n.length)r=n.shift(),r.fn.apply(r.scope||this,[e].concat(s)),r.type||i.push(r);t[e]=i},e.addListener=e.on,e.removeListener=e.off}}(RPC._util),function(e){e.JSON={stringify:JSON.stringify,parse:JSON.parse}}(RPC._util),function(e){function a(){var e=document.body.appendChild(document.createElement("form")),t=e.appendChild(document.createElement("input"));t.name="TEST"+Math.random().toString(16).substring(2),n=t!==e.elements[t.name],document.body.removeChild(e)}var t=e.dom={},n;if(e.lang.has(window,"addEventListener"))t.on=function(e,t,n){e.addEventListener(t,n,!1)},t.off=function(e,t,n){e.removeEventListener(t,n,!1)};else{if(!e.lang.has(window,"attachEvent"))throw new Error("Browser not supported");t.on=function(e,t,n){e.attachEvent("on"+t,n)},t.off=function(e,t,n){e.detachEvent("on"+t,n)}}var r=[],i,s=function(){if(t.isReady)return;t.isReady=!0,e.lang.each(r,function(e){setTimeout(e,0)}),r=[]};t.isReady=!1,t.ready=function(e){t.isReady?setTimeout(e,0):r.push(e)},"readyState"in document?(i=document.readyState,t.isReady=i=="complete"||~navigator.userAgent.indexOf("AppleWebKit/")&&(i=="loaded"||i=="interactive")):t.isReady=!!document.body;if(!t.isReady){if(e.lang.has(window,"addEventListener"))t.on(document,"DOMContentLoaded",s);else{t.on(document,"readystatechange",function(){document.readyState==="complete"&&s()});if(document.documentElement.doScroll&&window===top){var o=function(){if(t.isReady)return;try{document.documentElement.doScroll("left")}catch(e){setTimeout(o,1);return}s()};o()}}t.on(window,"load",s)}var u=t.createFrame=function(t){var r,i=t.nameString||e.JSON.stringify({RPC:{remote:window.location.href,channel:t.channel,protocol:t.protocol,remoteDomain:document.domain,remoteOrigin:e.url.getOrigin(window.location.href),helper:t.helper}});return t.props=t.props||{},n?r=document.createElement("<iframe name='"+i+"'/>"):(r=document.createElement("IFRAME"),r.name=i),typeof t.container=="string"&&(t.container=document.getElementById(t.container)),e.lang.extend(r.style,t.props.style,!0),t.container||(e.lang.extend(r.style,{position:"absolute",top:"-2000px",left:"0px"},!0),t.container=document.body),t.props.src="javascript:false",e.lang.extend(r,t.props,!0),r.border=r.frameBorder=0,r.allowTransparency=!0,t.container.appendChild(r),t.onLoad&&e.dom.on(r,"load",t.onLoad),r.src=t.remote,r}}(RPC._util),function(e){e.windowName=function(t){return t.name===""&&(t.name="{}"),{set:function(n,r){var i;i=e.JSON.parse(t.name),i[n]=r,t.name=e.JSON.stringify(i)},get:function(n){return e.JSON.parse(t.name)[n]},remove:function(n){var r;r=e.JSON.parse(t.name);var i=r[n];return delete r[n],t.name=e.JSON.stringify(r),i},clear:function(){var e=t.name;return t.name="{}",e},toString:function(){return t.name},toJSON:function(){return t.name}}};var t={};try{t=e.windowName(window)}catch(n){}e.lang.extend(e.windowName,t,!0),e.checkACL=function(e,t){if(!e||!e.length)return!0;typeof e=="string"&&(e=[e]);var n,r=e.length;while(r--){n=e[r],n=new RegExp(n.substr(0,1)=="^"?n:"^"+n.replace(/(\*)/g,".$1").replace(/\?/g,".")+"$");if(n.test(t))return!0}return!1},e.chainStack=function(e){var t={incoming:function(){},outgoing:function(e){t.down.outgoing(e)},init:function(){t.down.init()},ready:function(){},reset:function(){},destroy:function(){t.down.destroy()}};for(var n=0,r=e.length;n<r;n++)stackEl=e[n],n!==0&&(stackEl.down=e[n-1]),n!==r-1?stackEl.up=e[n+1]:(stackEl.up=t,t.down=stackEl);return t}}(RPC._util),function(e,t){e.verify=function(e){function s(){n=Math.random().toString(16).substring(2),t.down.outgoing(n)}var t,n,r,i=!1;return t={incoming:function(i){var o=i.indexOf("_");o===-1?i===n?t.up.ready():r||(r=i,e.isHost&&s(),t.down.outgoing(i)):i.substring(0,o)===r&&t.up.incoming(i.substring(o+1))},outgoing:function(e,r){t.down.outgoing(n+"_"+e,r)},init:function(){t.down.init()},ready:function(t){n="",r="",e.isHost||s()},destroy:function(){n="",r="",t.down.destroy()}}}}(RPC.behavior,RPC._util),function(e){e.queue=function(e){function o(){if(i||n.length===0)return;i=!0;var e=n.shift();t.down.outgoing(e.data,function(){e.callback&&setTimeout(function(){e.callback()},0),i=!1,o()})}var t,n=[],r,i=!0,s=1500;return t={incoming:function(e){var n=e.indexOf("_"),i=parseInt(e.substring(0,n),10);r+=e.substring(n+1),i===0&&(e=r,r="",t.up.incoming(e))},outgoing:function(e,t){if(e.length>s){var r=[],i;while(e.length!==0)i=e.substring(0,s),e=e.substring(i.length),r.push(i);while(i=r.shift())n.push({data:r.length+"_"+i,callback:r.length===0?t:null})}else n.push({data:"0_"+e,callback:t});o()},init:function(){t.down.init()},ready:function(e){n=[],i=!1,r="",o(),t.up.ready()},destroy:function(){n=[],i=!0,r="",t.down.destroy()}}}}(RPC.behavior),function(e){e.reliable=function(e){var t,n,r=0,i=0,s="";return t={incoming:function(e){var o=e.indexOf("_"),u=e.substring(0,o).split(",");e=e.substring(o+1);if(u[0]==r){s="";if(n){var a=n;n=null,a(!0)}}e.length>0&&(t.down.outgoing(u[1]+","+r+"_"+s),i!=u[1]&&(i=u[1],t.up.incoming(e)))},outgoing:function(e,o){s=e,n=o,t.down.outgoing(i+","+ ++r+"_"+e)},init:function(){t.down.init()},ready:function(){r=0,i=0,s="",n=null,t.up.ready()},destroy:function(){r=0,i=0,s="",n=null,t.down.destroy()}}}}(RPC.behavior),function(e,t){e.buffer=function(e){var n=[],r={incoming:function(e){r.up.incoming(e)},outgoing:function(e){n.push(e)},init:function(){r.down.init()},ready:function(){r.incoming=r.up.incoming,r.outgoing=r.down.outgoing,t.lang.each(n,function(e){r.outgoing(e)}),r.up.ready()},destroy:function(){n=[],r.down.destroy()}};return r}}(RPC.behavior,RPC._util),function(e,t){e.hash=function(e){function f(){if(!i)return;var e=i.location.href,t="",r=e.indexOf("#");r!=-1&&(t=e.substring(r));if(t&&t!==o){o=t;var s=o.substring(o.indexOf("_")+1);n.incoming(s)}}function l(){u=setInterval(f,e.interval)}function c(){clearInterval(u)}var n,r,i,s,o,u,a=!1;return n={incoming:function(e,t){e==="ready"?n.ready(t):n.up.incoming(e)},outgoing:function(e){var t=s+"#_"+e;r.contentWindow.location=t},init:function(){e.isHost?window.RPC_Fn.set(e.channel+"helper_ready",function(n,o){t.checkACL(e.acl,o)&&(i=n,r=e.iframe,s=o,l(),t.dom.on(n,"unload",function(){c()}))}):(r=t.dom.createFrame({nameString:e.channel+"helper_ready"+" "+window.location.href,remote:e.helper,onLoad:function(){s=e.helper,n.outgoing("ready")}}),i=window,l())},ready:function(){e.isHost&&n.outgoing("ready"),n.up.ready()},destroy:function(){r&&r.parentNode&&r.parentNode.removeChild&&r.parentNode.removeChild(r)}}}}(RPC.behavior,RPC._util),function(e,t){function n(e){if(e.origin)return t.url.getOrigin(e.origin);if(e.uri)return t.url.getOrigin(e.uri);if(e.domain)return location.protocol+"//"+e.domain;throw"Unable to retrieve the origin of the event"}e.postMessage=function(e){var r=e.remoteOrigin,i={postMessage:function(){}};t.dom.on(window,"message",function(i){if(i.data.indexOf(e.channel)===0){var o=t.url.getDomain(n(i)),u=i.data.substr(e.channel.length+1);if(!t.checkACL(e.acl,o))throw new Error(o+" is not in Access Control List!");u==="ready"?(r=n(i),e.isHost&&s.outgoing("ready"),s.up.ready()):s.incoming(u)}});var s={incoming:function(e){s.up.incoming(e)},outgoing:function(t){i.postMessage(e.channel+"_"+t,r)},init:function(){if(e.isHost){var n=e.iframe;i="postMessage"in n.contentWindow?n.contentWindow:n.contentWindow.document}else i="postMessage"in window.parent?window.parent:window.parent.document,t.dom.ready(function(){s.outgoing("ready")})},ready:function(){s.up.ready()},reset:function(){},destroy:function(){e.iframe.parentNode.removeChild(e.iframe)}};return s}}(RPC.behavior,RPC._util),function(e,t){e.sameorigin=function(e){var t,n;return e.isHost?(n={outgoing:function(e){t.incoming(e)}},t={incoming:function(e){e==="ready"?t.ready():t.up.incoming(e)},outgoing:function(e){setTimeout(function(){n.incoming(e)},0)},init:function(){},ready:function(){t.up.ready(),t.outgoing("ready")},reset:function(){},destroy:function(){e.iframe.parentNode.removeChild(e.iframe)}},window.RPC_Fn.set(e.channel+"get_remote",function(){return n})):(n=window.parent.RPC_Fn.get(e.channel+"get_remote")(),n.incoming=function(e){t.incoming(e)},t={incoming:function(e){e==="ready"?t.ready():t.up.incoming(e)},outgoing:function(e){setTimeout(function(){n.outgoing(e)},0)},init:function(){t.outgoing("ready")},ready:function(){t.up.ready()},reset:function(){},destroy:function(){}}),t}}(RPC.behavior,RPC._util),function(e,t){e.Transport=function(n){var r=this,i=[];t.eventEmiter(this);var s={},o;n.props||(n.props={});if(n.isHost)typeof n.isSameOrigin=="undefined"&&(n.isSameOrigin=t.url.getMainDomain(window.location.href)===t.url.getMainDomain(n.remote)),n.remoteOrigin=t.url.getOrigin(n.remote)||t.url.getOrigin(window.location.href),n.isSameOrigin?n.protocol="0":window.postMessage||document.postMessage?n.protocol="1":n.protocol="2";else{s=t.windowName.get("RPC");if(!s)throw new Error("arguments missing");n.channel=s.channel,n.protocol=s.protocol,n.remote=s.remote,n.helper=s.helper,n.remoteOrigin=s.remoteOrigin,s.remoteDomain===document.domain?n.isSameOrigin=!0:n.isSameOrigin=!1}if(!t.checkACL(n.acl,t.url.getDomain(n.remote)))throw new Error("Access denied for "+n.remote);switch(n.protocol){case"0":i=[new e.behavior.sameorigin(n)];break;case"1":i=[new e.behavior.postMessage(n)];break;case"2":t.lang.extend(n,{interval:20}),i=[new e.behavior.hash(n),new e.behavior.reliable(n),new e.behavior.queue(n),new e.behavior.verify(n)]}i.push(new e.behavior.buffer(n)),i=t.chainStack(i),this.send=function(e){i.outgoing(e)},this.init=function(){n.isHost&&(n.iframe=t.dom.createFrame(n)),i.init(),i.incoming=function(e){r.emit("message",e)},i.ready=function(){r.emit("ready")}},this.destroy=function(){i.destroy()}}}(RPC,RPC._util);